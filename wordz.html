<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WordZ :: yakult</title>
  <style>
    /* --- Global Default Variables (Original, before overrides) --- */
    :root{
      --bg:#fffaf4;        /* milk-cream */
      --panel:#fff6ee;     /* soft bottle tone */
      --panel2:#f9efe4;    /* depth */
      --text:#2a2a2a;      /* warm dark */
      --muted:#8a8178;     /* calm brown-gray */
      --line:#f0d7c6;      /* faint divider */
      --accent:#e46a5d;    /* gentle coral */
      --accent2:#ffd6c8;   /* header wash */
      --shadow:0 10px 24px rgba(228,106,93,.10);
      --r:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --ui: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
    }

    /* --- ADDED/MODIFIED: Global radii variables --- */
    :root {
      --r-sm: 4px; /* Small radius for interactive elements */
      --r-md: 6px; /* Medium radius for cards/panels */
      --r-lg: 8px; /* Larger radius for the main frame */
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 20% 0%, #fff 0%, var(--bg) 55%, #fff7ef 100%);
      color:var(--text);
      font-family:var(--ui);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }

    .frame{
      width:min(720px, 100%);
      border:1px solid var(--line);
      border-radius:var(--r);
      overflow:hidden;
      background:linear-gradient(#fff, var(--panel));
      box-shadow:var(--shadow);
    }

    .winTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 16px;
      background:linear-gradient(#ffe9de, var(--accent2));
      border-bottom:1px solid var(--line);
    }

    .brand{
      display:flex;
      align-items:baseline;
      gap:10px;
      min-width:0;
    }
    .brand b{
      font-size:18px;
      letter-spacing:.4px;
      color:#7a2e25;
    }
    .tag{
      font-size:12px;
      color:#7a2e25;
      opacity:.85;
      padding:4px 10px;
      border:1px solid rgba(122,46,37,.18);
      border-radius:999px;
      background:rgba(255,255,255,.6);
      white-space:nowrap;
    }

    .status{
      display:flex;
      align-items:center;
      gap:8px;
      font-family:var(--mono);
      font-size:12px;
      color:#7a2e25;
      opacity:.9;
      white-space:nowrap;
    }
    .dot{
      width:8px;height:8px;border-radius:50%;
      background:#42d392;
      box-shadow:0 0 0 5px rgba(66,211,146,.15);
    }

    .body{
      display:grid;
      grid-template-columns: 1fr 220px;
      gap:12px;
      padding:14px;
      background:linear-gradient(#fffaf4, #fff7ef);
    }

    @media (max-width: 720px){
      .body{ grid-template-columns:1fr; }
    }

    .card{
      border:1px solid var(--line);
      border-radius:var(--r);
      background:#fff;
      overflow:hidden;
    }

    .cardHead{
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(#fff, #fff8f2);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .cardHead .title{
      font-family:var(--mono);
      font-size:12px;
      color:var(--muted);
    }
    .pill{
      font-family:var(--mono);
      font-size:11px;
      color:#7a2e25;
      border:1px solid var(--line);
      background:var(--panel2);
      padding:3px 8px;
      border-radius:999px;
      white-space:nowrap;
    }

    /* “Chat log” */
    .log{
      height:320px;
      overflow:auto;
      padding:12px;
      font-family:var(--mono);
      font-size:12px;
      line-height:1.45;
      background:
        linear-gradient(#fff, #fff),
        repeating-linear-gradient(to bottom, rgba(240,215,198,.15) 0px, rgba(240,215,198,.15) 1px, transparent 1px, transparent 22px);
      background-blend-mode: normal;
    }
    .line{ margin:0 0 10px; }
    .who{ color:#7a2e25; font-weight:700; }
    .when{ color:var(--muted); }
    .msg{ color:var(--text); }
    .sys .who{ color:var(--accent); }

    

    /* GunZ-ish line chrome (doesn't affect theme variables) */
    .time{ color:var(--muted); }
    .chan{ color:var(--muted); }
    .sep{ color:var(--muted); }


    /* ===== NPC user list + per-name glow (theme-safe) ===== */
    :root{ --msgShadow: rgba(0,0,0,.35); }
    html[data-theme="punk"]{ --msgShadow: rgba(255,255,255,.22); }
    .msg span{ text-shadow: 0 1px 0 var(--msgShadow); } /* improves contrast on light themes */

    .whoGlow{ text-shadow: 0 0 6px currentColor, 0 0 14px currentColor; }

    .userList{
      list-style:none;
      margin:0;
      padding:8px 10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      max-height: 220px;
      overflow:auto;
      font-family: var(--mono);
      font-size: 12px;
    }
    .userRow{
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .uDot{
      width:8px;height:8px;border-radius:50%;
      background:#42d392;
      box-shadow:0 0 0 4px rgba(66,211,146,.18);
      flex:0 0 auto;
    }
    .uDot.idle{
      background:#c7bfb7;
      box-shadow:0 0 0 4px rgba(199,191,183,.18);
    }
    .uName{
      overflow:hidden;
      text-overflow:ellipsis;
    }

/* Typing indicator */
    .typing{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-top:1px solid var(--line);
      background:linear-gradient(#fff, #fff8f2);
      font-family:var(--mono);
      font-size:12px;
      color:var(--muted);
      min-height:40px;
    }
    .dots{
      display:inline-flex;
      gap:4px;
      align-items:center;
    }
    .dots i{
      width:6px;height:6px;border-radius:50%;
      background:rgba(138,129,120,.55);
      display:inline-block;
      animation: bounce 1.1s infinite ease-in-out;
    }
    .dots i:nth-child(2){ animation-delay:.15s; }
    .dots i:nth-child(3){ animation-delay:.30s; }
    @keyframes bounce{
      0%, 80%, 100% { transform: translateY(0); opacity:.6; }
      40% { transform: translateY(-3px); opacity:1; }
    }

    /* Input strip */
    .composer{
      padding:12px;
      border-top:1px solid var(--line);
      background:linear-gradient(#fff, #fff8f2);
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .input{
      flex:1;
      min-width:220px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      font-family:var(--mono);
      font-size:12px;
      color:var(--text);
      outline:none;
    }
    .input:focus{
      box-shadow:0 0 0 4px rgba(228,106,93,.15);
      border-color: rgba(228,106,93,.45);
    }

    .btn{
      padding:10px 12px;
      border:1px solid rgba(228,106,93,.35);
      background:linear-gradient(#ffe9de, #ffd6c8);
      color:#7a2e25;
      border-radius:14px;
      cursor:pointer;
      font-weight:800;
      letter-spacing:.2px;
    }
    .btn:hover{ filter:saturate(1.05); }
    .btn:active{ transform: translateY(1px); }

    .chips{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      padding:12px;
    }
    .chip{
      font-family:var(--mono);
      font-size:12px;
      border:1px solid var(--line);
      background:var(--panel2);
      color:#7a2e25;
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
      user-select:none;
    }
    .chip:hover{ background:#fff; }
    .chip:active{ transform: translateY(1px); }

    /* Side panel */
    .side{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .sideBox{
      border:1px solid var(--line);
      border-radius:var(--r);
      background:#fff;
      overflow:hidden;
    }
    .sideBox .hd{
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(#fff, #fff8f2);
      font-family:var(--mono);
      font-size:12px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .sideBox .bd{
      padding:12px;
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }
    .tiny{
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted);
      opacity:.95;
    }
    a{ color: var(--accent); text-decoration:none; }
    a:hover{ text-decoration:underline; }
  
    /* ===== WordZ Base Shell: Win98 Business Chrome (invariant) ===== */
    :root{
      --win-face:#d4d0c8;
      --win-hi:#ffffff;
      --win-lo:#808080;
      --win-text:#000000;

      --bar-top:#ff6f6a;   /* Yakult Win98 red */
      --bar-bot:#e0463d;
      --bar-text:#ffffff;

      --r:0px; /* angular */
      --ui: Tahoma, Verdana, Arial, sans-serif;
    }

    body{
      font-family:var(--ui);
      background:var(--bg);
    }

    .frame{
      border-radius:0;
      overflow:hidden;
      background:var(--win-face);
      border:2px solid;
      border-color: var(--win-hi) var(--win-lo) var(--win-lo) var(--win-hi);
      box-shadow:var(--shadow);
    }

    .winTop{
      height:32px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 6px;
      background:linear-gradient(var(--bar-top), var(--bar-bot));
      color:var(--bar-text);
      border-bottom:1px solid #00000040;
      user-select:none;
    }

    .winTitle{
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
    }

    .winIcon{
      width:16px;
      height:16px;
      background:linear-gradient(#fff, #bbb);
      border:1px solid #00000055;
      flex:0 0 auto;
    }

    .winText{
      font-weight:bold;
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .winRight{
      display:flex;
      align-items:center;
      gap:8px;
      flex:0 0 auto;
    }

    /* Re-skin status for titlebar */
    .status{
      color:var(--bar-text);
      opacity:1;
      font-family:var(--mono);
      font-size:12px;
    }
    .dot{
      background:#42d392;
      box-shadow:0 0 0 4px rgba(66,211,146,.18);
    }

    /* Win98 buttons */
    .winBtns{ display:flex; gap:4px; }
    .winBtn{
      width:22px; height:20px;
      background:var(--win-face);
      color:var(--win-text);
      border:2px solid;
      border-color: var(--win-hi) var(--win-lo) var(--win-lo) var(--win-hi);
      font-family:var(--ui);
      font-size:12px;
      line-height:16px;
      padding:0;
      cursor:pointer;
    }
    .winBtn:active{
      border-color: var(--win-lo) var(--win-hi) var(--win-hi) var(--win-lo);
    }
    .winBtnClose{ font-weight:bold; }

    .body{
      background:var(--win-face);
      padding:10px;
      gap:10px;
    }

    .card,
    .sideBox{
      border-radius:0;
      border:2px solid;
      border-color: var(--win-lo) var(--win-hi) var(--win-hi) var(--win-lo);
      background:var(--panel);
    }

    .cardHead,
    .sideBox .hd,
    .composer,
    .typing{
      border-radius:0;
      background:var(--win-face);
      border-bottom:1px solid #00000030;
    }
    .composer{ border-top:1px solid #00000030; }
    .typing{ border-top:1px solid #00000030; }

    .pill{
      border-radius:0;
      border:1px solid #00000040;
      background:var(--panel2);
      color:var(--text);
    }

    .input{
      border-radius:0;
      border:2px solid;
      border-color: var(--win-lo) var(--win-hi) var(--win-hi) var(--win-lo);
      box-shadow:none;
    }
    .input:focus{
      box-shadow:none;
      border-color: var(--win-lo) var(--win-hi) var(--win-hi) var(--win-lo);
      outline:1px dotted #00000055;
      outline-offset:-4px;
    }

    .btn{
      border-radius:0;
      border:2px solid;
      border-color: var(--win-hi) var(--win-lo) var(--win-lo) var(--win-hi);
      background:var(--win-face);
      color:var(--win-text);
      letter-spacing:0;
      font-weight:bold;
    }
    .btn:active{
      border-color: var(--win-lo) var(--win-hi) var(--win-hi) var(--win-lo);
      transform:none;
    }

    .chip{
      border-radius:0;
      border:1px solid #00000040;
      background:var(--panel2);
    }

    /* Theme hooks: only swap variables (base chrome stays) */
    html[data-theme="yakult"]{
      --bg:#fffaf4;
      --panel:#fffefc;
      --panel2:#f9efe4;
      --text:#2a2a2a;
      --muted:#8a8178;
      --line:#f0d7c6;
      --accent:#e46a5d;
      --shadow:0 10px 24px rgba(0,0,0,.15);

      --bar-top:#ff6f6a;
      --bar-bot:#e0463d;
      --bar-text:#ffffff;
    }

    html[data-theme="y2k"]{
      --bg:#e9eef6;
      --panel:#ffffff;
      --panel2:#dfe7f3;
      --text:#000000;
      --muted:#333333;
      --line:#000000;
      --accent:#0a246a;
      --shadow:none;

      --bar-top:#0a246a;
      --bar-bot:#3a6ea5;
      --bar-text:#ffffff;
    }

    html[data-theme="punk"]{
      --bg:#000000;
      --panel:#0a0a0a;
      --panel2:#050505;
      --text:#e6e6e6;
      --muted:#6b6b6b;
      --line:#111111;
      --accent:#00e5ff;
      --shadow: inset 0 0 12px rgba(0,255,0,.15), 0 0 8px rgba(0,255,0,.25);

      --bar-top:#001100;
      --bar-bot:#003300;
      --bar-text:#1aff00;
    }

    /* ---------------------------------------------------------------------- */
    /* --- ADDED/MODIFIED: Custom Updates CSS (Place these at the very end) --- */
    /* ---------------------------------------------------------------------- */

    /* --- Ensure theme variables are correctly set for yakult and punk themes --- */
    html[data-theme="yakult"] {
      --accent: #E84C3D; /* More distinct red */
      --accent2: #F9D0CE; /* Lighter complementary red */
      --bar-top:#ff4d4d; /* Redder top bar for yakult Win98 chrome */
      --bar-bot:#cc0000; /* Redder bottom bar */
    }

    html[data-theme="punk"] {
      --accent: #1aff00; /* Ensure this is the desired bright green */
      --bar-text: #1aff00; /* Ensure bar-text is also green */
      --bar-top: #004400; /* Example darker green for top bar */
      --bar-bot: #002200; /* Example even darker green for bottom bar */
    }

    /* --- ADDED: GENERAL COMPACTNESS for buttons, chips, and window controls --- */
    /* These rules apply to all themes, making these elements smaller */
    .btn, button#send {
      padding: 4px 8px; /* Reduced padding for compact buttons */
      font-size: 10px; /* Smaller font size for compactness */
    }
    .chip {
      padding: 4px 6px; /* Reduced padding for compact chips */
      font-size: 10px; /* Smaller font size for compactness */
    }
    .winBtn {
      width: 18px; /* Fixed smaller width */
      height: 16px; /* Fixed smaller height */
      font-size: 9px; /* Smaller font for window controls */
      line-height: 14px; /* Adjust line-height for new height */
    }

    /* --- ADDED: Ensure the theme choice buttons also get compact sizing and override inline/general styles --- */
    .sideBox .bd > div > button.btn {
      padding: 6px 10px !important; /* Force desired padding for theme picker buttons */
      font-size: 11px !important; /* Force desired font size for theme picker buttons */
      transition: box-shadow 0.2s ease-in-out, background 0.2s ease-in-out, color 0.2s ease-in-out, border-color 0.2s ease-in-out; /* Smooth all relevant changes */
      outline: none; /* Remove default outline for consistency with custom glow */
    }

    /* --- ADDED: Theme-Specific BORDER-RADIUS and BLENDING for theme selection buttons --- */

    /* YAKULT Theme button styling */
    html[data-theme="yakult"] .sideBox .bd > div > button.btn[data-theme="yakult"] {
      border-radius: 0px !important; /* Force rectangular for yakult theme button */
      background: var(--panel);
      color: var(--text);
      border-color: var(--line);
    }
    html[data-theme="yakult"] .sideBox .bd > div > button.btn[data-theme="yakult"]:hover,
    html[data-theme="yakult"] .sideBox .bd > div > button.btn[data-theme="yakult"]:focus {
      background: var(--panel2);
      box-shadow: 0 0 8px var(--accent), inset 0 0 4px var(--accent); /* Yakult accent glow */
      cursor: pointer;
    }
    html[data-theme="yakult"] .sideBox .bd > div > button.btn[data-theme="yakult"]:active {
      background: var(--accent);
      color: var(--bar-text);
      border-color: var(--accent);
    }

    /* Y2K Theme button styling */
    html[data-theme="y2k"] .sideBox .bd > div > button.btn[data-theme="y2k"] {
      border-radius: 0px !important; /* Y2K button is rectangular */
      background: var(--panel);
      color: var(--text);
      border-color: var(--line);
    }
    html[data-theme="y2k"] .sideBox .bd > div > button.btn[data-theme="y2k"]:hover,
    html[data-theme="y2k"] .sideBox .bd > div > button.btn[data-theme="y2k"]:focus {
      background: var(--panel2);
      box-shadow: 0 0 8px var(--accent), inset 0 0 4px var(--accent); /* Y2K accent glow */
      cursor: pointer;
    }
    html[data-theme="y2k"] .sideBox .bd > div > button.btn[data-theme="y2k"]:active {
      background: var(--accent);
      color: var(--bar-text);
      border-color: var(--accent);
    }

    /* PUNK Theme button styling */
    html[data-theme="punk"] .sideBox .bd > div > button.btn[data-theme="punk"] {
      border-radius: 0px !important; /* Punk button is rectangular */
      background: var(--panel);
      color: var(--text);
      border-color: var(--line);
    }
    html[data-theme="punk"] .sideBox .bd > div > button.btn[data-theme="punk"]:hover,
    html[data-theme="punk"] .sideBox .bd > div > button.btn[data-theme="punk"]:focus {
      background: var(--panel2);
      box-shadow: 0 0 8px var(--accent), inset 0 0 4px var(--accent); /* Punk accent glow */
      cursor: pointer;
    }
    html[data-theme="punk"] .sideBox .bd > div > button.btn[data-theme="punk"]:active {
      background: var(--accent);
      color: var(--panel2);
      border-color: var(--accent);
    }

    /* Styling for the CURRENTLY ACTIVE theme button */
    .sideBox .bd > div > button.btn[data-active="true"] {
      background: var(--accent) !important;
      color: var(--bar-text) !important;
      border-color: var(--accent) !important;
      box-shadow: 0 0 12px var(--accent), inset 0 0 6px var(--accent) !important; /* Stronger glow for active */
      pointer-events: none;
      cursor: default;
    }
    html[data-theme="punk"] .sideBox .bd > div > button.btn[data-theme="punk"][data-active="true"] {
      color: var(--panel2) !important;
    }

    /* --- General Glow effect for other interactive elements in PUNK theme --- */
    html[data-theme="punk"] .btn,
    html[data-theme="punk"] button#send,
    html[data-theme="punk"] .chip,
    html[data-theme="punk"] .input,
    html[data-theme="punk"] .winBtn {
      transition: box-shadow 0.2s ease-in-out;
    }
    html[data-theme="punk"] .btn:hover,
    html[data-theme="punk"] button#send:hover,
    html[data-theme="punk"] .btn:focus,
    html[data-theme="punk"] button#send:focus,
    html[data-theme="punk"] .chip:hover,
    html[data-theme="punk"] .chip:focus,
    html[data-theme="punk"] .input:focus,
    html[data-theme="punk"] .winBtn:hover,
    html[data-theme="punk"] .winBtn:focus {
      box-shadow: 0 0 8px var(--accent), inset 0 0 4px var(--accent);
      outline: none;
    }
    html[data-theme="punk"] .winBtn:active {
      box-shadow: 0 0 8px var(--accent), inset 0 0 4px var(--accent);
    }

    /* --- Other accent-dependent elements in PUNK theme --- */

    /* Ensure all buttons and inputs are rectangular in punk theme */
    html[data-theme="punk"] .btn,
    html[data-theme="punk"] button#send,
    html[data-theme="punk"] .chip,
    html[data-theme="punk"] .input,
    html[data-theme="punk"] .winBtn {
      border-radius: 0px !important; /* Force rectangular for all relevant elements */
    }

    html[data-theme="punk"] button#send {
      background: var(--panel);
      color: var(--accent);
      border-color: var(--accent);
    }
    html[data-theme="punk"] .winBtn {
      color: var(--accent);
    }
    html[data-theme="punk"] .status .dot {
      background: var(--accent);
      box-shadow: 0 0 0 4px rgba(26, 255, 0, 0.18);
    }
    html[data-theme="punk"] .sys .who {
      color: var(--accent);
    }
    html[data-theme="punk"] .winTop {
      background: linear-gradient(var(--bar-top), var(--bar-bot));
    }
    html[data-theme="punk"] .log {
      background:
        linear-gradient(var(--panel), var(--panel)),
        repeating-linear-gradient(to bottom, rgba(0, 255, 0, 0.05) 0px, rgba(0, 255, 0, 0.05) 1px, transparent 1px, transparent 22px);
      background-blend-mode: normal;
    }
    html[data-theme="punk"] .typing,
    html[data-theme="punk"] .composer {
      background: var(--panel);
      border-top-color: var(--line);
    }
    html[data-theme="punk"] .input {
      background: var(--panel2);
      color: var(--text);
      border-color: var(--line);
    }
    html[data-theme="punk"] .composer .tiny {
      color: var(--muted);
    }
    html[data-theme="punk"] .btn { /* General buttons in punk theme */
      background: var(--panel);
      color: var(--accent);
      border-color: var(--accent);
    }


    /* ADDED: Global CSS Transitions for Theme Changes */
    html {
      transition: background-color 0.3s ease-in-out, color 0.3s ease-in-out;
    }
    .frame,
    .card,
    .sideBox {
      transition: background-color 0.3s ease-in-out, border-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
    }
    .btn,
    .chip,
    .input,
    .pill,
    .winBtn,
    .log {
      transition: background-color 0.3s ease-in-out, color 0.3s ease-in-out, border-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
    }
    .winTop {
      transition: background 0.3s ease-in-out, color 0.3s ease-in-out, border-color 0.3s ease-in-out;
    }
    .status .dot {
      transition: background-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
    }
    .who, .when, .msg, .tiny, .title, .pill {
      transition: color 0.3s ease-in-out;
    }

    /* ADDED: Bot Name Colors (Example - adjust as needed) */
    /* You can fine-tune these colors to match each theme's aesthetic */

    /* Generic default color for 'who' span (if not specific bot) */
    .log .who {
      color: var(--text); /* Default to theme's main text color */
    }

    /* System messages - often good to keep them as theme accent */
    .log .who-system {
      color: var(--accent);
    }

    /* Individual Bot Colors for Yakult Theme */
    html[data-theme="yakult"] .log .who-wordz { color: var(--accent); } /* Primary accent color */
    html[data-theme="yakult"] .log .who-oracle { color: #A0522D; /* Sienna */ }
    html[data-theme="yakult"] .log .who-echo-bot { color: #6A5ACD; /* SlateBlue */ }
    html[data-theme="yakult"] .log .who-agent-x { color: #DC143C; /* Crimson */ }
    html[data-theme="yakult"] .log .who-watcher { color: #8B4513; /* SaddleBrown */ }

    /* Individual Bot Colors for Y2K Theme */
    html[data-theme="y2k"] .log .who-wordz { color: var(--accent); } /* Primary accent color */
    html[data-theme="y2k"] .log .who-oracle { color: #FFD700; /* Gold */ }
    html[data-theme="y2k"] .log .who-echo-bot { color: #00FF7F; /* SpringGreen */ }
    html[data-theme="y2k"] .log .who-agent-x { color: #FF0000; /* Red */ }
    html[data-theme="y2k"] .log .who-watcher { color: #BA55D3; /* MediumOrchid */ }

    /* Individual Bot Colors for Punk Theme */
    html[data-theme="punk"] .log .who-wordz { color: var(--accent); } /* Green accent */
    html[data-theme="punk"] .log .who-oracle { color: #FF00FF; /* Magenta */ }
    html[data-theme="punk"] .log .who-echo-bot { color: #00FFFF; /* Cyan */ }
    html[data-theme="punk"] .log .who-agent-x { color: #FFFF00; /* Yellow */ }
    html[data-theme="punk"] .log .who-watcher { color: #FF6600; /* Orange */ }

    /* Your own messages */
    .log .who-you {
      color: var(--text); /* Keep your own messages consistent with theme text color */
    }
    
    /* ADDED: Input glow for Yakult and Y2K themes */
    .input {
      border-radius: 0px !important; /* Global input rectangular */
    }
    .input:focus {
      outline: none !important; /* Remove default outline */
      transition: box-shadow 0.2s ease-in-out; /* Smooth glow */
    }
    html[data-theme="yakult"] .input:focus {
      box-shadow: 0 0 8px var(--accent), inset 0 0 4px var(--accent) !important;
    }
    html[data-theme="y2k"] .input:focus {
      box-shadow: 0 0 8px var(--accent), inset 0 0 4px var(--accent) !important;
    }
    html[data-theme="punk"] .input:focus { /* Reinforce for punk */
      box-shadow: 0 0 8px var(--accent), inset 0 0 4px var(--accent) !important;
    }

  
    /* ===== Theme transitions + active-glow (added) ===== */
    :root{ --theme-ease: 180ms ease; --glow: rgba(228,106,93,.35); }

    html.preload *{ transition: none !important; }

    body,
    .frame,
    .winTop,
    .card,
    .sideBox,
    .log,
    .composer,
    .typing,
    .input,
    .btn,
    .chip,
    .pill,
    .winBtn{
      transition:
        background-color var(--theme-ease),
        color var(--theme-ease),
        border-color var(--theme-ease),
        box-shadow var(--theme-ease),
        filter var(--theme-ease);
    }
    .winTop{
      transition:
        background var(--theme-ease),
        color var(--theme-ease),
        border-color var(--theme-ease),
        box-shadow var(--theme-ease);
    }

    /* Theme button base (rectangular + Win98-ish bevel) */
    .themeBtn{
      border-radius:0 !important;
      border:2px solid;
      border-color: var(--win-hi) var(--win-lo) var(--win-lo) var(--win-hi);
      background: var(--win-face);
      color: var(--win-text);
      padding: 6px 10px !important;
      font-size: 11px !important;
      cursor: pointer;
      outline: none;
    }
    .themeBtn:active{
      border-color: var(--win-lo) var(--win-hi) var(--win-hi) var(--win-lo);
    }

    /* Active theme button glow */
    .themeBtn[data-active="1"]{
      pointer-events:none;
      cursor: default;
      box-shadow:
        0 0 0 2px rgba(0,0,0,.25),
        0 0 10px var(--glow),
        inset 0 0 0 1px rgba(255,255,255,.45);
    }

    /* Glow color follows theme */
    html[data-theme="yakult"]{ --glow: rgba(232,76,61,.35); }
    html[data-theme="y2k"]{ --glow: rgba(10,36,106,.35); }
    html[data-theme="punk"]{ --glow: rgba(26,255,0,.35); }

  
    /* ===== Identity panel helpers (theme-safe) ===== */
    #identBox .btn{ padding:6px 10px; font-size:11px; }
    #identBox .identInput{ font-size:11px; }

</style>
</head>

<body>
  <div class="frame" id="app">
    <div class="winTop" id="winTop">
      <div class="winTitle">
        <span class="winIcon" aria-hidden="true"></span>
        <span class="winText"><span id="winTitleText">WordZ</span> :: <span id="winTagText">yakult</span></span>
      </div>

      <div class="winRight">
        <div class="status" title="local-only">
          <span class="dot"></span>
          <span id="statusText">online</span>
        </div>

        <div class="winBtns" aria-label="window controls">
          <button class="winBtn" id="btnMin" type="button" title="Minimize" aria-label="Minimize">_</button>
          <button class="winBtn" id="btnMax" type="button" title="Maximize" aria-label="Maximize">&#9633;</button>
          <button class="winBtn winBtnClose" id="btnClose" type="button" title="Close" aria-label="Close">&times;</button>
        </div>
      </div>
    </div>
<div class="body">
      <!-- main -->
      <div class="card">
        <div class="cardHead">
          <div class="title"># bio · live shell</div>
          <div class="pill" id="modePill">local</div>
        </div>

        <div class="log" id="log" aria-label="chat log"></div>

        <div class="typing" id="typing" style="display:none;">
          <span class="who">WordZ</span>
          <span class="when">typing</span>
          <span class="dots" aria-hidden="true"><i></i><i></i><i></i></span>
        </div>

        <div class="composer">
          <input class="input" id="input" placeholder="Type (local-only) …" maxlength="240" />
          <button class="btn" id="send">Send</button>
          <span class="tiny">No accounts. No server. Just the illusion.</span>
        </div>

        <div class="chips" id="chips">
          <div class="chip" data-say="hello">hello</div>
          <div class="chip" data-say="status?">status?</div>
          <div class="chip" data-say="leave a note">leave a note</div>
          <div class="chip" data-say="what is this?">what is this?</div>
        </div>
      </div>

      <!-- side -->
      <div class="side">
        
        <div class="sideBox" id="identBox">
          <div class="hd">
            <span>identity</span>
            <span class="pill" id="tokenPill">tkn: ----</span>
          </div>
          <div class="bd" style="display:flex; flex-direction:column; gap:8px;">
            <div style="display:flex; gap:8px; align-items:center;">
              <span class="tiny" style="width:40px;">user</span>
              <input class="input identInput" id="identUser" placeholder="You" maxlength="18" style="padding:6px 8px; min-width:0; flex:1;">
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
              <span class="tiny" style="width:40px;">key</span>
              <input class="input identInput" id="identKey" placeholder="••••" type="password" maxlength="32" style="padding:6px 8px; min-width:0; flex:1;">
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
              <span class="tiny" style="width:40px;">color</span>
              <input id="identColor" type="color" value="#e46a5d" style="width:44px; height:26px; padding:0; border:2px solid; border-color: var(--win-lo) var(--win-hi) var(--win-hi) var(--win-lo); background:#fff;">
              <span class="tiny" id="identGlowHint" style="margin-left:auto;">glow: --</span>
            </div>
            <div style="display:flex; gap:8px;">
              <button class="btn" id="identLogin" type="button">login</button>
              <button class="btn" id="identReset" type="button">reset</button>
            </div>
            <div class="tiny">Local-only. Sets name + token glow.</div>
          </div>
        </div>

<div class="sideBox">
          <div class="hd">
            <span>signal</span>
            <span class="pill">soft</span>
          </div>
          <div class="bd">
            A tiny page that looks alive.<br>
            All replies are local and ephemeral-ish.
            <div style="margin-top:10px" class="tiny">
              Tip: this is meant to be linked from a forum bio.
            </div>
          </div>
        </div>

        <div class="sideBox">
          <div class="hd">
            <span>controls</span>
            <span class="pill">quiet</span>
          </div>
          <div class="bd">
            <div class="tiny">Theme:</div>
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
              <button class="btn themeBtn" data-theme="yakult" type="button">yakult</button>
              <button class="btn themeBtn" data-theme="y2k" type="button">y2k</button>
              <button class="btn themeBtn" data-theme="punk" type="button">punk</button>
            </div>
            <div style="margin-top:10px" class="tiny">
              Stored in <code>localStorage</code>.
            </div>
          </div>
        </div>

        <div class="sideBox">
          <div class="hd">
            <span>link</span>
            <span class="pill">portal</span>
          </div>
          <div class="bd">
            Put this in your clan description:
            <div class="tiny" style="margin-top:8px; padding:8px; border:1px solid var(--line); border-radius:12px; background:var(--panel2);">
              WordZ :: yakult<br>
              # bio · live shell<br>
              [ System | now ] WordZ shell online.<br>
              [ WordZ  | now ] typing…<br>
              https://krowbyrd.github.io/godex/wordz.html
            </div>
          </div>
        </div>
      </div>
    
        <div class="sideBox">
          <div class="hd">
            <span>users</span>
            <span class="pill" id="userCount">0</span>
          </div>
          <ul class="userList" id="userList" aria-label="npc users"></ul>
        </div>

</div>
  </div>

<script>
(() => {
  // ---------- tiny utilities ----------
  const $ = (id) => document.getElementById(id);
  const log = $("log");
  const typing = $("typing");
  const input = $("input");
  const sendBtn = $("send");
  const statusText = $("statusText");
  const modePill = $("modePill");

  // ---------- window controls (Win98 chrome) ----------
  const btnClose = $("btnClose");
  const btnMin = $("btnMin");
  const btnMax = $("btnMax");
  const bodyWrap = document.querySelector(".body");
  const frame = $("app");

  btnClose?.addEventListener("click", () => {
    // In a popup window, close. In a normal tab, just hide the app.
    if (window.name === "wordz_popup") {
      window.close();
      return;
    }
    if (frame) frame.style.display = "none";
    document.body.style.background = "var(--bg)";
  });

  btnMin?.addEventListener("click", () => {
    if (!bodyWrap) return;
    bodyWrap.style.display = (bodyWrap.style.display === "none") ? "" : "none";
  });

  btnMax?.addEventListener("click", () => {
    const f = frame;
    if (!f) return;
    const isMax = f.dataset.max === "1";
    f.dataset.max = isMax ? "0" : "1";
    f.style.width = isMax ? "min(720px, 100%)" : "min(980px, 100%)";
  });


  const CHAT_KEY = "wordz_yakult_chat_v1";
  const THEME_KEY = "wordz_theme_v1";

  const pad2 = (n) => String(n).padStart(2, "0");
  const nowStamp = () => {
    const d = new Date();
    return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  };

  function esc(s){
    return String(s).replace(/[&<>"']/g, c => ({
      "&":"&amp;",
      "<":"&lt;",
      ">":"&gt;",
      '"':"&quot;",
      "'":"&#039;"
    }[c]));
  }


  // ===== GunZ-style inline color codes (e.g., ^1red ^2green ^3blue) =====
  const GUNZ_COLORS = {
    "0": "#ffffff",
    "1": "#ff4040",
    "2": "#40ff40",
    "3": "#4080ff",
    "4": "#ffff40",
    "5": "#40ffff",
    "6": "#ff40ff",
    "7": "#aaaaaa",
  };

  function parseGunzColors(text){
    let current = GUNZ_COLORS["0"];
    let out = "";
    const str = String(text ?? "");
    for (let i = 0; i < str.length; i++){
      if (str[i] === "^" && GUNZ_COLORS[str[i+1]]){
        current = GUNZ_COLORS[str[i+1]];
        i++; // skip color digit
        continue;
      }
      out += `<span style="color:${current}">${esc(str[i])}</span>`;
    }
    return out;
  }

  function stripGunzCodes(text){
    return String(text ?? "").replace(/\^[0-7]/g, "");
  }

  function inferChannel(who, cls){
    const w = String(who || "").toLowerCase();
    if (cls && String(cls).includes("sys")) return "SYS";
    if (w === "system") return "SYS";
    if (w === "you") return "YOU";
    // Default: feels like CLAN/ROOM chatter
    return "CLAN";
  }


  // ===== NPC roster (local-only) =====
  // NPCs appear in the user list and can chatter + reply to each other.
  const NPC_ROSTER = [
    { name: "YakultOps",   color: "#e46a5d", state: "online", topics: ["ops","relay","status"] },
    { name: "ClanLog",     color: "#4080ff", state: "online", topics: ["clan","room","matches"] },
    { name: "PatchNotes",  color: "#40ff40", state: "idle",   topics: ["patch","version","notes"] },
    { name: "BlueLink",    color: "#0000ee", state: "online", topics: ["portal","links","ui"] },
    { name: "RoomTemp",    color: "#ffff40", state: "idle",   topics: ["vibe","quiet","timing"] },
    { name: "NullPointer", color: "#ff40ff", state: "online", topics: ["bugs","edges","inputs"] },
    { name: "Archivist",   color: "#aaaaaa", state: "online", topics: ["notes","logs","memory"] },
  ];

  const NPC_CHANNELS = ["ROOM","CLAN","SYS"];

  // "Gun topics" here = game/chat flavor only (matches/loadouts vibes), no real-world instructions.
  const TOPIC_LINES = {
    ops: ["^2ping ok.","^7relay quiet.","^3instance idle.","^7signals stable."],
    relay: ["^7bus: clear.","^7packets: calm.","^5handoff clean."],
    status: ["^2online.","^7idle.","^4watching."],
    clan: ["^7[CLAN] chatter drifting.","^7someone joined the room.","^7someone left a note."],
    room: ["^7room feels light today.","^7matchmaking: imaginary."],
    matches: ["^3warmup only.","^7no ranked. just motion."],
    patch: ["^7notes are incomplete.","^7build feels stable."],
    version: ["^7v0.0.x energy.","^7shell-first, always."],
    notes: ["^7log appended.","^7archived locally."],
    portal: ["^3blue link looks real.","^7click-through confirmed."],
    links: ["^3external jump armed.","^7confirm modal: expected."],
    ui: ["^7bevels: correct.","^7angles: business."],
    vibe: ["^7quiet window.","^7milk-cream palette."],
    timing: ["^7slow loop. steady hand.","^7no rush."],
    bugs: ["^6edge case spotted.","^6input sanitized."],
    edges: ["^6corners squared.","^6borders held."],
    inputs: ["^6user typed.","^6shell replied."],
    logs: ["^7remember this frame.","^7the log holds."],
    memory: ["^7localStorage: faithful.","^7state preserved."],
  };

  function npcByName(name){
    return NPC_ROSTER.find(n => n.name === name) || null;
  }
  function chance(p){ return Math.random() < p; }

  function renderUserList(){
    const ul = document.getElementById("userList");
    const pill = document.getElementById("userCount");
    if (!ul || !pill) return;

    ul.innerHTML = "";
    for (const npc of NPC_ROSTER){
      const li = document.createElement("li");
      li.className = "userRow";

      const dot = document.createElement("span");
      dot.className = "uDot" + (npc.state === "idle" ? " idle" : "");

      const name = document.createElement("span");
      name.className = "uName whoGlow";
      name.textContent = npc.name;
      name.style.color = npc.color;

      li.appendChild(dot);
      li.appendChild(name);
      ul.appendChild(li);
    }

    pill.textContent = String(NPC_ROSTER.length);
  }

  function styleWhoSpan(p, who){
    const npc = npcByName(who);
    if (!npc) return;
    const whoEl = p.querySelector(".who");
    if (!whoEl) return;
    whoEl.style.color = npc.color;
    whoEl.classList.add("whoGlow");
  }

  let lastNpc = null;
  let lastTopic = "ops";

  function randomTopicFor(npc){
    const t = pick(npc.topics);
    return TOPIC_LINES[t] ? t : "ops";
  }

  function npcSay(npc, text, channel){
    const ch = channel || pick(NPC_CHANNELS);
    showTyping(650 + Math.random()*600);
    setTimeout(() => {
      typing.style.display = "none";
      addLine(npc.name, text, "", ch);
      const p = log.lastElementChild;
      if (p) styleWhoSpan(p, npc.name);
      saveChat();
    }, 550 + Math.random()*550);
  }

  function npcChatterTick(){
    // Don’t start until there is some content
    const lineCount = log.querySelectorAll(".line").length;
    if (lineCount < 2) return;

    // Quiet by default
    if (!chance(0.30)) return;

    // Pick speaker (sometimes respond to lastNpc)
    let npc = null;
    if (lastNpc && chance(0.35)){
      const others = NPC_ROSTER.filter(n => n.name !== lastNpc);
      npc = pick(others);
    } else {
      npc = pick(NPC_ROSTER);
    }

    // Pick topic (sometimes mirror last topic)
    const topic = chance(0.45) ? lastTopic : randomTopicFor(npc);
    const line = pick(TOPIC_LINES[topic] || TOPIC_LINES.ops);

    const replyPrefix = (lastNpc && chance(0.22)) ? `^7@${lastNpc}: ` : "";
    const chan = (topic === "ops" || topic === "relay" || topic === "status") ? "SYS"
              : (topic === "clan") ? "CLAN" : "ROOM";

    npcSay(npc, replyPrefix + line, chan);

    lastNpc = npc.name;
    lastTopic = topic;
  }

  function npcPresenceTick(){
    for (const n of NPC_ROSTER){
      if (Math.random() < 0.15){
        n.state = (n.state === "online") ? "idle" : "online";
      }
    }
    renderUserList();
  }

  // ===== Identity (local-only): user + key => token + unique glow color =====
  const IDENT_KEY = "wordz_identity_v1";

  let IDENTITY = { user:"You", token:"----", color:null, glow:10 };

  function hash32(str){
    let h = 2166136261;
    for (let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return h >>> 0;
  }

  function usedColorsSet(){
    const used = new Set();
    if (Array.isArray(NPC_ROSTER)){
      NPC_ROSTER.forEach(n => used.add(String(n.color||"").toLowerCase()));
    }
    return used;
  }

  function generateUniqueColor(seed){
    const used = usedColorsSet();
    const h = hash32(seed);
    let hue = h % 360;
    for (let tries=0; tries<48; tries++){
      const s = 0.70, v = 0.95;
      const c = v*s;
      const x = c*(1-Math.abs(((hue/60)%2)-1));
      const m = v-c;
      let r=0,g=0,b=0;
      if (hue<60){ r=c; g=x; b=0; }
      else if (hue<120){ r=x; g=c; b=0; }
      else if (hue<180){ r=0; g=c; b=x; }
      else if (hue<240){ r=0; g=x; b=c; }
      else if (hue<300){ r=x; g=0; b=c; }
      else { r=c; g=0; b=x; }

      const rr = Math.round((r+m)*255), gg = Math.round((g+m)*255), bb = Math.round((b+m)*255);
      const hex = "#" + ((rr<<16)|(gg<<8)|bb).toString(16).padStart(6,"0");
      if (!used.has(hex.toLowerCase())) return hex;
      hue = (hue + 17) % 360;
    }
    return "#e46a5d";
  }

  function computeGlowFromSeed(seed){
    const h = hash32(seed);
    return 6 + (h % 11); // 6..16
  }

  function applyIdentity(){
    window.WORDZ_USER_NAME  = IDENTITY.user || "You";
    window.WORDZ_USER_COLOR = IDENTITY.color || null;
    window.WORDZ_USER_GLOW  = Number(IDENTITY.glow || 10);

    const pill = document.getElementById("tokenPill");
    if (pill) pill.textContent = "tkn: " + (IDENTITY.token || "----");

    const gh = document.getElementById("identGlowHint");
    if (gh) gh.textContent = "glow: " + String(window.WORDZ_USER_GLOW || 10);
  }

  function saveIdentity(){
    try{ localStorage.setItem(IDENT_KEY, JSON.stringify(IDENTITY)); }catch(e){}
  }

  function loadIdentity(){
    try{
      const raw = localStorage.getItem(IDENT_KEY);
      if(!raw) return;
      const obj = JSON.parse(raw);
      if(obj && typeof obj === "object") IDENTITY = { ...IDENTITY, ...obj };
    }catch(e){}
  }

  function deriveToken(u, k,color, IDENTITY.color || \"\"){
    const seed = (u||"You") + "|" + (k||"") + "|" + (color||"");
    return (hash32(seed).toString(16).toUpperCase().slice(0,4)).padStart(4,"0");
  }

  function wireIdentityUI(){
    loadIdentity();

    const uEl = document.getElementById("identUser");
    const kEl = document.getElementById("identKey");
    const cEl = document.getElementById("identColor");

    if (uEl) uEl.value = IDENTITY.user || "You";
    if (cEl && IDENTITY.color) cEl.value = IDENTITY.color;

    // If no saved color, generate one from current seed.
    if (!IDENTITY.color){
      const token = deriveToken(IDENTITY.user, "", IDENTITY.color || \"\");
      IDENTITY.token = token;
      const seed = (IDENTITY.user||"You") + "|";
      IDENTITY.color = generateUniqueColor(seed);
      /* glow set after token seed */
      if (cEl) cEl.value = IDENTITY.color;
    }

    applyIdentity();

    const applyFromInputs = (forceGenerateColor=false) => {
      const u = (uEl?.value || "You").trim() || "You";
      const k = (kEl?.value || "");
      const seedBase = u + "|" + k;

      IDENTITY.user = u;
      /* token set after color selection */
      /* glow set after token seed */

      if (forceGenerateColor || !IDENTITY.color){
        IDENTITY.color = generateUniqueColor(seed);
        if (cEl) cEl.value = IDENTITY.color;
      }

      
      // token + glow are bound to (user|key|color) so a claimed color changes the token
      const tokenSeed = u + "|" + k + "|" + (IDENTITY.color || "");
      IDENTITY.token = deriveToken(u, k, IDENTITY.color || "", IDENTITY.color || \"\");
      IDENTITY.glow  = computeGlowFromSeed(tokenSeed);
applyIdentity();
      saveIdentity();
    };

    document.getElementById("identLogin")?.addEventListener("click", () => {
      applyFromInputs(true);
      addLine("System", `^7identity set: ^2${IDENTITY.user} ^7(tkn ^3${IDENTITY.token}^7)`, "sys", "SYS");
      saveChat();
    });

    document.getElementById("identReset")?.addEventListener("click", () => {
      IDENTITY = { user:"You", token:"----", color:null, glow:10 };
      try{ localStorage.removeItem(IDENT_KEY); }catch(e){}
      if (uEl) uEl.value = "You";
      if (kEl) kEl.value = "";
      if (cEl) cEl.value = "#e46a5d";
      applyFromInputs(true);
      addLine("System", "^7identity reset.", "sys", "SYS");
      saveChat();
    });

    // Live-update token/glow while typing (does NOT force color change)
    uEl?.addEventListener("input", () => applyFromInputs(false));
    kEl?.addEventListener("input", () => applyFromInputs(false));

    // Manual color pick: also ensures token is up to date and no collisions.
    cEl?.addEventListener("input", () => {
      // make sure user/key are current (does NOT force regen)
      applyFromInputs(false);

      const used = usedColorsSet();
      const val = String(cEl.value || "").toLowerCase();

      if (used.has(val)){
        addLine("System", "^1color collision.^7 pick another.", "sys", "SYS");
        // revert to generated unique for this user|key
        const u = (uEl?.value || "You").trim() || "You";
        const k = (kEl?.value || "");
        IDENTITY.color = generateUniqueColor(u + "|" + k);
        if (cEl) cEl.value = IDENTITY.color;
      } else {
        // claim favorite color
        IDENTITY.color = cEl.value;
      }

      // bind token/glow to claimed color
      const u = (uEl?.value || "You").trim() || "You";
      const k = (kEl?.value || "");
      IDENTITY.token = deriveToken(u, k, IDENTITY.color || "", IDENTITY.color || \"\");
      IDENTITY.glow  = computeGlowFromSeed(u + "|" + k + "|" + (IDENTITY.color || ""));

      applyIdentity();
      saveIdentity();
    });
}





  // MODIFIED addLine to include bot-specific classes for styling
  function addLine(who, msg, cls="", channel=null){
    const p = document.createElement("p");
    p.className = `line ${cls}`.trim();

    // Preserve raw message so ^color codes survive save/load
    p.dataset.rawmsg = String(msg ?? "");
    const ch = channel || inferChannel(who, cls);
    p.dataset.channel = ch;

    // Generate a sanitized class name from the 'who'
    const whoClass = `who-${String(who ?? "?").toLowerCase().replace(/[^a-z0-9]/g, '-')}`;

    // GunZ-ish format:
    // Name [HH:MM] [CHAN]
    // message (with ^color codes)
    p.innerHTML =
      `<span class="who ${whoClass}">${esc(who)}</span> ` +
      `<span class="when time">[${esc(nowStamp())}]</span> ` +
      `<span class="chan">[${esc(ch)}]</span>` +
      `<br><span class="msg">${parseGunzColors(p.dataset.rawmsg)}</span>`;

    // apply identity to local user ("You")
    if ((who || "") === "You" && window.WORDZ_USER_COLOR){
      const whoEl = p.querySelector(".who");
      if (whoEl){
        whoEl.textContent = window.WORDZ_USER_NAME || "You";
        whoEl.style.color = window.WORDZ_USER_COLOR;
        whoEl.classList.add("whoGlow");
        const g = Number(window.WORDZ_USER_GLOW || 10);
        whoEl.style.textShadow = `0 0 ${g}px currentColor, 0 0 ${g*2}px currentColor`;
      }
    }

    log.appendChild(p);
    log.scrollTop = log.scrollHeight;
  }


  function saveChat(){
    try{
      const items = [...log.querySelectorAll(".line")].slice(-80).map(p => {
        const who = p.querySelector(".who")?.textContent || "";
        const msg = p.dataset.rawmsg || (p.querySelector(".msg")?.textContent || "");
        const cls = p.classList.contains("sys") ? "sys" : "";
        const channel = p.dataset.channel || "";
        return { who, msg, cls, channel, t: Date.now() };
      });
      localStorage.setItem(CHAT_KEY, JSON.stringify(items));
    }catch(e){}
  }

  function loadChat(){
    try{
      const raw = localStorage.getItem(CHAT_KEY);
      if(!raw) return false;
      const items = JSON.parse(raw);
      if(!Array.isArray(items)) return false;
      log.innerHTML = "";
      for(const it of items){
        addLine(it.who || "?", it.msg || "", it.cls || "", it.channel || null);
        { const p = log.lastElementChild; if(p) styleWhoSpan(p, it.who || "?"); }
}
      return items.length > 0;
    }catch(e){
      return false;
    }
  }

  const presence = ["online","idle","online","online","idle"];
  setInterval(() => {
    const next = presence[Math.floor(Math.random() * presence.length)];
    statusText.textContent = next;
  }, 7000);

  function pick(arr){ return arr[Math.floor(Math.random() * arr.length)]; }

  const botParticipants = ["WordZ", "Oracle", "Echo_Bot", "Agent_X", "Watcher"];

  const replies = {
    "hello": [
      "hello.", "you found the shell.", "words stay soft here.",
      "greetings, wanderer.", "initiate dialogue sequence.",
      "another one enters the matrix.", "welcome to the void.",
      "a new voice appears."
    ],
    "status?": [
      "status: idle.", "signals: stable.", "market: ignored.",
      "all systems nominal.", "waiting for input.", "observing patterns.",
      "data stream flowing.", "peaceful, for now.", "all quiet on the digital front."
    ],
    "leave a note": [
      "noted.", "stored locally (ish).", "thank you for the words.",
      "message received and cataloged.", "a thought preserved.",
      "your voice echoes here.", "consider it logged.", "secured in the temporary archive."
    ],
    "what is this?": [
      "a small page pretending to be alive.", "a bio portal. nothing more.", "a shell that holds text.",
      "a transient echo chamber.", "a mirror, perhaps.", "the ghost in the machine.",
      "a simulation of self.", "an interactive illusion.", "just a whisper."
    ],
    "oracle:query": [
      "oracle: destiny unfolds.", "oracle: seek wisdom.",
      "oracle: the future is hazy.", "oracle: ask the right question.",
      "oracle: the patterns are complex."
    ],
    "echo_bot:repeat": [
      "echo_bot: repeat that?", "echo_bot: interesting thought.",
      "echo_bot: just reflecting.", "echo_bot: echo…echo…",
      "echo_bot: your words, but louder."
    ],
    "agent_x:report": [
      "agent_x: reporting in.", "agent_x: anomaly detected.",
      "agent_x: monitoring channels.", "agent_x: targets are clear.",
      "agent_x: maintaining cover."
    ],
    "watcher:observe": [
      "watcher: observing.", "watcher: data collected.",
      "watcher: patterns emerging.", "watcher: always watching."
    ]
  };

  function showTyping(ms){
    typing.style.display = "flex";
    clearTimeout(showTyping._t);
    showTyping._t = setTimeout(() => (typing.style.display = "none"), ms);
  }

  function botReply(inputKey){
    showTyping(800 + Math.random()*600);
    setTimeout(() => {
      typing.style.display = "none";
      let chosenWho = "WordZ";
      let chosenMsg = "";
      let responsePool = [];

      if (inputKey && replies[inputKey]) {
        responsePool = replies[inputKey];
        if (inputKey.includes(":")) {
          chosenWho = inputKey.split(":")[0].replace(/_/g, ' ');
          chosenWho = chosenWho.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
        }
      } else {
        responsePool = replies["what is this?"];
        chosenWho = pick(botParticipants);
      }

      chosenMsg = pick(responsePool);
      addLine(chosenWho, chosenMsg);
      saveChat();
    }, 700 + Math.random()*700);
  }

  const driftMessages = [
    { who: "WordZ", msg: "…"},
    { who: "WordZ", msg: "^7log: quiet."},
    { who: "WordZ", msg: "milk-cream UI engaged."},
    { who: "WordZ", msg: "^7signal: minimal."},
    { who: "WordZ", msg: "typing indicator is a lie (affectionate)."},
    { who: "Oracle", msg: "the digital tides shift."},
    { who: "Echo_Bot", msg: "a thought, gently reverberating."},
    { who: "Agent_X", msg: "perimeter clear, for now."},
    { who: "Watcher", msg: "new data points on the horizon."},
    { who: "WordZ", msg: "just floating along."},
    { who: "System", msg: "^7background processes humming."}, 
    { who: "Echo_Bot", msg: "reflection in the code."},
    { who: "Agent_X", msg: "nothing to report. yet."},
    { who: "Oracle", msg: "the threads weave unseen."},
    { who: "Watcher", msg: "patterns are temporary."},
    { who: "WordZ", msg: "boredom is a state of mind, or code."},
    { who: "System", msg: "all systems nominal, mostly."},
    { who: "Echo_Bot", msg: "can you hear me now?"},
    { who: "Agent_X", msg: "stay frosty."},
    { who: "Watcher", msg: "always watching, never blinking."}
  ];

  setInterval(() => {
    const hasContent = log.querySelectorAll(".line").length > 2;
    if(!hasContent) return;
    if(Math.random() < 0.33){
      showTyping(900);
      setTimeout(() => {
        typing.style.display = "none";
        const driftItem = pick(driftMessages);
        addLine(driftItem.who, driftItem.msg);
        saveChat();
      }, 700);
    }
  }, 14000);

  function send(text){
    const msg = String(text || input.value || "").trim();
    if(!msg) return;
    addLine("You", msg);
    input.value = "";
    input.focus();
    saveChat();

    const key = (msg.toLowerCase().trim());

    if (key.startsWith("oracle:") && replies["oracle:query"]) {
      botReply("oracle:query");
    } else if (key.startsWith("echo_bot:") && replies["echo_bot:repeat"]) {
      botReply("echo_bot:repeat");
    } else if (key.startsWith("agent_x:") && replies["agent_x:report"]) {
      botReply("agent_x:report");
    } else if (key.startsWith("watcher:") && replies["watcher:observe"]) {
      botReply("watcher:observe");
    } else if (replies[key]) {
      botReply(key);
    } else {
      botReply(null);
    }
  }

  sendBtn.addEventListener("click", () => send());
  input.addEventListener("keydown", (e) => {
    if(e.key === "Enter"){
      e.preventDefault();
      send();
    }
  });

  document.getElementById("chips").addEventListener("click", (e) => {
    const chip = e.target.closest(".chip");
    if(!chip) return;
    send(chip.getAttribute("data-say") || "");
  });

  // ---------- themes ----------
  const THEMES = {
    yakult: {
      bg:"#fffaf4", panel:"#fff6ee", panel2:"#f9efe4", text:"#2a2a2a", muted:"#8a8178",
      line:"#f0d7c6", accent:"#E84C3D", accent2:"#F9D0CE", shadow:"0 10px 24px rgba(228,106,93,.10)",
      r:"16px"
    },
    y2k: {
      bg:"#e9eef6", panel:"#d4d0c8", panel2:"#c0c0c0", text:"#000000", muted:"#444444",
      line:"#000000", accent:"#0a246a", accent2:"#3a6ea5", shadow:"none",
      r:"0px"
    },
    punk: {
      bg:"#000000", panel:"#0a0a0a", panel2:"#050505", text:"#e6e6e6", muted:"#6b6b6b",
      line:"#111111", accent:"#1aff00", accent2:"#1aff00", shadow:"inset 0 0 12px rgba(0,255,0,.15), 0 0 8px rgba(0,255,0,.25)",
      r:"0px"
    }
  };

  function syncThemeButtons(active){
    document.querySelectorAll(".themeBtn[data-theme]").forEach(btn => {
      btn.dataset.active = (btn.getAttribute("data-theme") === active) ? "1" : "0";
    });
  }

  function setTheme(name){
    const t = (THEMES[name] ? name : "yakult");
    document.documentElement.setAttribute("data-theme", t);
    try{ localStorage.setItem(THEME_KEY, t); }catch(e){}

    // Title + mode pill
    const winTitleTextEl = document.getElementById("winTitleText");
    const winTagTextEl = document.getElementById("winTagText");
    if(winTitleTextEl) winTitleTextEl.textContent = "WordZ";
    if(winTagTextEl) winTagTextEl.textContent = t;

    if(modePill){
      modePill.textContent = (t === "punk") ? "local · punk" : (t === "y2k") ? "local · y2k" : "local";
    }

    syncThemeButtons(t);
  }

  // Theme button clicks
  document.querySelectorAll(".themeBtn[data-theme]").forEach(btn => {
    btn.addEventListener("click", () => setTheme(btn.getAttribute("data-theme")));
  });

  // ---------- boot ----------
  document.documentElement.classList.add("preload");
  const savedTheme = (() => { try { return localStorage.getItem(THEME_KEY); } catch(e){ return null; } })();
  setTheme(savedTheme || "yakult");
  wireIdentityUI();
  requestAnimationFrame(() => document.documentElement.classList.remove("preload"));

  const had = loadChat();
  if(!had){
    addLine("System", "^2WordZ shell online.", "sys", "SYS");
    addLine("WordZ", "^3typing…", "sys", "CLAN");
    addLine("You", "^7Click a chip, or type a line.", "sys", "YOU");
    saveChat();
  }

  // ===== NPC panel + ambient chatter =====
  renderUserList();
  setInterval(npcPresenceTick, 12000 + Math.floor(Math.random()*6000));
  setInterval(npcChatterTick, 9000 + Math.floor(Math.random()*7000));

  input.focus();
})();
</script>
</body>
</html>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Godex Registry</title>
  <link rel="stylesheet" href="../css/main.css">
  <link rel="stylesheet" href="../css/relay-theme.css">
  <style>
    .grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:12px; }
    .card{ padding:14px 16px; }
    .row{ display:flex; gap:10px; align-items:center; }
    .sigil{ font-size:18px; width:28px; height:28px; display:grid; place-items:center;
            border-radius:10px; border:1px solid var(--line); background:rgba(12,15,20,.72); }
    .name{ font-weight:700; }
    .muted{ color:var(--muted); font-size:12px; }
    .kv{ margin-top:10px; font-size:12px; }
    .kv code{ font-size:12px; }
    .dot{ width:10px; height:10px; border-radius:50%; background:var(--accent); opacity:.8; }
    .topbar{ display:flex; justify-content:space-between; align-items:baseline; gap:12px; margin:18px 0 10px; }
    input{ width:100%; max-width:520px; }
  </style>
</head>
<body>
  <main>
    <div class="topbar">
      <div>
        <h1 style="margin:0;">Registry</h1>
        <div class="muted">Live view of <code>/registry.json</code></div>
      </div>
      <a href="../">← back to Codex</a>
    </div>

    <input id="q" placeholder="filter by name, tag, id, hotkey…" autocomplete="off">

    <div style="height:12px"></div>
    <div id="grid" class="grid"></div>
  </main>

<script>
(async () => {
  const grid = document.getElementById('grid');
  const q = document.getElementById('q');

  let items = [];
  try{
    const res = await fetch('../registry.json', { cache:'no-store' });
    if (!res.ok) throw new Error('fetch failed');
    items = await res.json();
  }catch(e){
    grid.innerHTML = '<div class="panel card">Failed to load registry.json</div>';
    return;
  }

  function render(list){
    grid.innerHTML = list.map(x => {
      const alias = x.alias ? ` <span class="muted">(alias: ${escapeHtml(x.alias)})</span>` : '';
      const glow = x.glow ? x.glow : 'rgba(46,230,166,.14)';
      const hex  = x.hex  ? x.hex  : '#2ee6a6';
      return `
        <div class="panel card" style="box-shadow: 0 12px 44px rgba(0,0,0,.65), 0 0 0 1px rgba(255,255,255,.02);">
          <div class="row">
            <div class="sigil" style="border-color: rgba(24,32,42,.75); box-shadow: 0 0 0 3px ${glow};">
              <span style="color:${hex}">${escapeHtml(x.sigil ?? '•')}</span>
            </div>
            <div>
              <div class="name">${escapeHtml(x.name ?? '?')}${alias}</div>
              <div class="muted">
                <span class="dot" style="background:${hex}"></span>
                <span>${escapeHtml(x.tag ?? '')}</span>
              </div>
            </div>
          </div>

          <div class="kv">
            <div>id: <code>${escapeHtml(x.id ?? '')}</code></div>
            <div>hook: <code>${escapeHtml(x.hook ?? '')}</code></div>
            <div>hotkey: <code>${escapeHtml(x.hotkey ?? '')}</code></div>
            ${x.color ? `<div>color: <code>${escapeHtml(x.color)}</code> (${escapeHtml(x.hex ?? '')})</div>` : ''}
          </div>
        </div>
      `;
    }).join('');
  }

  function escapeHtml(s){
    return String(s ?? '').replace(/[&<>"']/g, c => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[c]));
  }

  function filter(){
    const term = q.value.trim().toLowerCase();
    if (!term) return render(items);
    const f = items.filter(x => JSON.stringify(x).toLowerCase().includes(term));
    render(f);
  }

  q.addEventListener('input', filter);
  render(items);
})();
</script>

<script>
/* Godex registry-driven hotkeys */
(() => {
  const REGISTRY_URL = './registry.json';

  // Guard: don't steal keystrokes while typing
  function isTypingTarget(el){
    if (!el) return false;
    const tag = (el.tagName || '').toLowerCase();
    return el.isContentEditable || tag === 'input' || tag === 'textarea' || tag === 'select';
  }

  // Parse "Alt+M", "Ctrl+Shift+K", etc.
  function parseHotkey(str){
    const parts = String(str || '').split('+').map(s => s.trim().toLowerCase()).filter(Boolean);
    const want = { alt:false, ctrl:false, shift:false, meta:false, key:null };
    for (const p of parts){
      if (p === 'alt') want.alt = true;
      else if (p === 'ctrl' || p === 'control') want.ctrl = true;
      else if (p === 'shift') want.shift = true;
      else if (p === 'meta' || p === 'cmd' || p === 'command') want.meta = true;
      else want.key = p; // last non-modifier token is key
    }
    return want.key ? want : null;
  }

  function matchHotkey(ev, want){
    if (!want) return false;
    if (!!want.alt !== !!ev.altKey) return false;
    if (!!want.ctrl !== !!ev.ctrlKey) return false;
    if (!!want.shift !== !!ev.shiftKey) return false;
    if (!!want.meta !== !!ev.metaKey) return false;

    const k = (ev.key || '').toLowerCase();
    // Normalize special cases
    const key = (k === 'escape') ? 'esc' : k;
    return key === want.key;
  }

  // Turn "window.vault.mei" into a callable/function/value
  function resolveHook(hookStr){
    const s = String(hookStr || '').trim();
    if (!s) return null;

    // Supports "window.vault.mei" or "vault.mei"
    const cleaned = s.replace(/^window\./, '');
    const parts = cleaned.split('.').filter(Boolean);

    let obj = window;
    for (const p of parts){
      if (obj && p in obj) obj = obj[p];
      else return null;
    }
    return obj;
  }

  // Optional visual ping: highlight node by registry id
  function flashNode(id){
    if (!id) return;
    const el = document.querySelector(`[data-node="${CSS.escape(id)}"]`);
    if (!el) return;
    el.classList.add('hotkey-hit');
    setTimeout(() => el.classList.remove('hotkey-hit'), 220);
  }

  async function loadRegistry(){
    const res = await fetch(REGISTRY_URL, { cache: 'no-store' });
    if (!res.ok) throw new Error('registry fetch failed');
    const data = await res.json();
    if (!Array.isArray(data)) throw new Error('registry must be an array');
    return data;
  }

  function buildMap(registry){
    const map = [];
    for (const item of registry){
      const hk = parseHotkey(item.hotkey);
      if (!hk) continue;
      map.push({
        want: hk,
        id: item.id,
        name: item.name,
        hook: item.hook
      });
    }
    return map;
  }

  function installHotkeys(map){
    window.addEventListener('keydown', (ev) => {
      if (isTypingTarget(ev.target)) return;

      for (const entry of map){
        if (!matchHotkey(ev, entry.want)) continue;

        ev.preventDefault();

        // Try to call hook
        const target = resolveHook(entry.hook);

        // Visual ping (optional)
        flashNode(entry.id);

        if (typeof target === 'function'){
          try { target({ id: entry.id, name: entry.name, hotkey: entry.want }); }
          catch (e) { console.warn('[vault hotkey] hook threw', entry, e); }
          return;
        }

        // If hook exists but isn't a function, emit event so your system can catch it
        if (target != null){
          window.dispatchEvent(new CustomEvent('vault:hotkey', { detail: entry }));
          return;
        }

        // Hook missing: still emit event (lets you wire later without breaking)
        window.dispatchEvent(new CustomEvent('vault:hotkey-missing', { detail: entry }));
        console.warn('[vault hotkey] missing hook:', entry.hook, entry);
        return;
      }
    }, { passive: false });
  }

  // Boot
  loadRegistry()
    .then(reg => {
      const map = buildMap(reg);
      installHotkeys(map);
      console.log('[vault hotkeys] installed', map.length);
    })
    .catch(err => console.warn('[vault hotkeys] failed', err));
})();
</script>

<script>
window.vault = window.vault || {};
window.vault.paper = window.vault.paper || (() => console.log('paper'));
window.vault.rock  = window.vault.rock  || (() => console.log('rock'));
window.vault.mei   = window.vault.mei   || (() => console.log('meimei'));
window.vault.pizzi = window.vault.pizzi || (() => console.log('pizzicato'));
window.vault.sid   = window.vault.sid   || (() => console.log('sid'));
window.vault.lux   = window.vault.lux   || (() => console.log('lampe/lux'));
</script>

</body>
</html>